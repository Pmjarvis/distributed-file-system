[2025-11-20 02:32:14] --- LOGGING STARTED ---
[2025-11-20 02:32:14] MAIN: Persistent log file initialized for SS ID 0
[2025-11-20 02:32:14] MAIN: Using persistent data directory: ss_data_0
[2025-11-20 02:32:14] MAIN: Loading metadata hash table (post-registration)...
[2025-11-20 02:32:14] Loading 2 metadata entries from ss_data_0/metadata.db...
[2025-11-20 02:32:14] Nested metadata hash table initialized: 1024 outer buckets Ã— 64 inner buckets (1024 locks)
[2025-11-20 02:32:14] DEBUG: Lazily created inner table for outer bucket 523
[2025-11-20 02:32:14] Inserted metadata for: f (owner: pat, size: 26, is_backup: 1)
[2025-11-20 02:32:14] DEBUG: Lazily created inner table for outer bucket 540
[2025-11-20 02:32:14] Inserted metadata for: w (owner: pat, size: 0, is_backup: 0)
[2025-11-20 02:32:14] Loaded 2/2 metadata entries from ss_data_0/metadata.db
[2025-11-20 02:32:14] MAIN: Loaded metadata for 2 files from disk
[2025-11-20 02:32:14] MAIN: Listening for Clients and NS on 127.0.0.2:9001
[2025-11-20 02:32:14] NS_CONTROL: Listener thread started for NS control messages
[2025-11-20 02:32:14] CHECKPOINT: Thread started (interval: 60 seconds)
[2025-11-20 02:32:14] MAIN: Listening for Replication on 127.0.0.2:9002
[2025-11-20 02:32:14] MAIN: Core listener & worker threads started (pre-file-scan). Ready for NS control messages.
[2025-11-20 02:32:14] MAIN: File scan complete (0 existing files added post-startup)
[2025-11-20 02:32:14] MAIN: No replication target assigned (single SS or no backup available)
[2025-11-20 02:32:14] MAIN: Server initialization complete (threads already running). Press Ctrl+C for graceful shutdown.
[2025-11-20 02:32:38] NS_CONTROL: Received message type 61 from NS
[2025-11-20 02:32:38] HANDLER: Received backup assignment update from NS
[2025-11-20 02:32:38] HANDLER: Backup assignment updated - will replicate to 127.0.0.3:9004 (SS ID 1)
[2025-11-20 02:32:38] HANDLER: Initiating immediate catch-up replication for existing primary files
[2025-11-20 02:32:38] REPL: Scheduling update for w
[2025-11-20 02:32:38] HANDLER: Catch-up replication scheduling complete (1 primary files queued)
[2025-11-20 02:32:38] NS_CONTROL: Received message type 60 from NS
[2025-11-20 02:32:38] RECOVERY: NS requests re-replication of all files to backup SS 1 (127.0.0.3:9004)
[2025-11-20 02:32:38] RECOVERY: Initiating immediate re-replication for existing primary files
[2025-11-20 02:32:38] REPL: Scheduling update for w
[2025-11-20 02:32:38] REPL: Scheduling update for w
[2025-11-20 02:32:38] RECOVERY: Re-replication scheduling complete (1 primary files queued)
[2025-11-20 02:32:38] REPL: Could not connect to backup server at 127.0.0.3:9004
[2025-11-20 02:32:38] REPL: Re-queueing w for retry attempt 1
[2025-11-20 02:32:38] REPL: Could not connect to backup server at 127.0.0.3:9004
[2025-11-20 02:32:38] REPL: Re-queueing w for retry attempt 2
[2025-11-20 02:32:38] REPL: Connected to backup. Replicating update for w...
[2025-11-20 02:32:38] REPL: Replicating w (owner: pat, size: 0)
[2025-11-20 02:32:38] REPL: Successfully replicated w (0 bytes)
[2025-11-20 02:32:38] REPL: ACK received for file w
[2025-11-20 02:32:38] REPL_IN: New incoming replication connection
[2025-11-20 02:32:38] REPL_IN: Receiving replica for f (26 bytes)
[2025-11-20 02:32:38] REPL: Connected to backup. Replicating update for w...
[2025-11-20 02:32:38] REPL: Replicating w (owner: pat, size: 0)
[2025-11-20 02:32:38] REPL: Successfully replicated w (0 bytes)
[2025-11-20 02:32:38] REPL: ACK received for file w
[2025-11-20 02:32:38] REPL_IN: Finished receiving f
[2025-11-20 02:32:38] Updated metadata for: f
[2025-11-20 02:32:38] REPL_IN: Updated metadata for f (owner: pat, size: 26, is_backup=true)
[2025-11-20 02:33:12] REPL_IN: New incoming replication connection
[2025-11-20 02:33:12] REPL_IN: Receiving replica for f (0 bytes)
[2025-11-20 02:33:12] REPL_IN: Finished receiving f
[2025-11-20 02:33:12] Updated metadata for: f
[2025-11-20 02:33:12] REPL_IN: Updated metadata for f (owner: bob, size: 0, is_backup=true)
[2025-11-20 02:33:14] CHECKPOINT: Saving metadata to disk...
[2025-11-20 02:33:14] Saving metadata to ss_data_0/metadata.db (atomic snapshot)...
[2025-11-20 02:33:14] Successfully saved 2 metadata entries (atomic snapshot)
[2025-11-20 02:33:14] CHECKPOINT: Metadata saved successfully (2 entries)
[2025-11-20 02:33:16] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 32)
[2025-11-20 02:33:16] DEBUG: Lazily created inner table for outer bucket 977
[2025-11-20 02:33:16] Inserted metadata for: ff (owner: bob, size: 0, is_backup: 0)
[2025-11-20 02:33:16] CREATE: File ff created by bob
[2025-11-20 02:33:16] REPL: Scheduling update for ff
[2025-11-20 02:33:16] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 02:33:16] REPL: Connected to backup. Replicating update for ff...
[2025-11-20 02:33:16] REPL: Replicating ff (owner: bob, size: 0)
[2025-11-20 02:33:16] REPL: Successfully replicated ff (0 bytes)
[2025-11-20 02:33:16] REPL: ACK received for file ff
[2025-11-20 02:33:26] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 42)
[2025-11-20 02:33:26] WRITE: Locked file ff (sentence 0)
[2025-11-20 02:33:26] WRITE: Appending sentence 0 to empty file
[2025-11-20 02:33:38] Updated size for ff: 9 bytes
[2025-11-20 02:33:38] Updated counts for ff: 5 words, 9 chars
[2025-11-20 02:33:38] WRITE: Updated metadata for ff (size: 9, words: 5, chars: 9)
[2025-11-20 02:33:38] WRITE: Completed for ff (sentence 0)
[2025-11-20 02:33:38] REPL: Scheduling update for ff
[2025-11-20 02:33:38] REPL: Connected to backup. Replicating update for ff...
[2025-11-20 02:33:38] REPL: Replicating ff (owner: bob, size: 9)
[2025-11-20 02:33:38] REPL: Successfully replicated ff (9 bytes)
[2025-11-20 02:33:38] REPL: ACK received for file ff
[2025-11-20 02:34:09] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 35)
[2025-11-20 02:34:09] EXEC: Read file ff, size=9 bytes, content='hey! hi!?'
[2025-11-20 02:34:09] EXEC: Sending content to NS: 'hey! hi!?'
[2025-11-20 02:34:09] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 02:34:11] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 40)
[2025-11-20 02:34:11] HANDLER: Routing to ss_handle_read() for message type 40
[2025-11-20 02:34:11] READ: Handler called for file 'ff'
[2025-11-20 02:34:11] READ: Starting read for file ff
[2025-11-20 02:34:11] READ: Full path is ss_data_0/files/ff
[2025-11-20 02:34:11] READ: File opened successfully, starting to read chunks
[2025-11-20 02:34:11] READ: Chunk 1 - read 9 bytes, is_final=1
[2025-11-20 02:34:11] READ: Chunk 1 sent
[2025-11-20 02:34:11] READ: Read complete for ff, sent 1 chunks
[2025-11-20 02:34:11] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 02:34:14] CHECKPOINT: Saving metadata to disk...
[2025-11-20 02:34:14] Saving metadata to ss_data_0/metadata.db (atomic snapshot)...
[2025-11-20 02:34:14] Successfully saved 3 metadata entries (atomic snapshot)
[2025-11-20 02:34:14] CHECKPOINT: Metadata saved successfully (3 entries)
[2025-11-20 02:34:47] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 41)
[2025-11-20 02:34:47] HANDLER: Routing to ss_handle_stream() for message type 41
[2025-11-20 02:34:47] STREAM: Handler called for file 'ff'
[2025-11-20 02:34:47] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 02:34:59] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 40)
[2025-11-20 02:34:59] HANDLER: Routing to ss_handle_read() for message type 40
[2025-11-20 02:34:59] READ: Handler called for file 'ff'
[2025-11-20 02:34:59] READ: Starting read for file ff
[2025-11-20 02:34:59] READ: Full path is ss_data_0/files/ff
[2025-11-20 02:34:59] READ: File opened successfully, starting to read chunks
[2025-11-20 02:34:59] READ: Chunk 1 - read 9 bytes, is_final=1
[2025-11-20 02:34:59] READ: Chunk 1 sent
[2025-11-20 02:34:59] READ: Read complete for ff, sent 1 chunks
[2025-11-20 02:34:59] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 02:35:03] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 34)
[2025-11-20 02:35:03] INFO: NS requesting metadata for ff (for VIEW -l)
[2025-11-20 02:35:03] INFO: Returning cached metadata for ff (size: 9, words: 5, chars: 9)
[2025-11-20 02:35:03] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 02:35:10] MAIN: Shutdown detected. Joining threads and performing final cleanup...
[2025-11-20 02:35:10] CHECKPOINT: Thread exiting
[2025-11-20 02:35:10] REPL_LISTENER: Thread exiting
[2025-11-20 02:35:11] NS_CONTROL: Listener thread exiting
[2025-11-20 02:35:11] CLIENT_LISTENER: Thread exiting
[2025-11-20 02:35:14] HEARTBEAT: Thread exiting
[2025-11-20 02:35:14] MAIN: Performing final metadata save (3 entries)...
[2025-11-20 02:35:14] Saving metadata to ss_data_0/metadata.db (atomic snapshot)...
[2025-11-20 02:35:14] Successfully saved 3 metadata entries (atomic snapshot)
[2025-11-20 02:35:14] MAIN: Final metadata save successful
[2025-11-20 02:35:14] Nested metadata hash table freed (1024 locks destroyed)
[2025-11-20 02:35:14] REPL: Worker thread shutting down.
[2025-11-20 02:35:14] --- LOGGING STOPPED ---
