[2025-11-20 04:21:58] --- LOGGING STARTED ---
[2025-11-20 04:21:58] MAIN: Persistent log file initialized for SS ID 1
[2025-11-20 04:21:58] MAIN: Using persistent data directory: ss_data_1
[2025-11-20 04:21:58] MAIN: Loading metadata hash table (post-registration)...
[2025-11-20 04:21:58] Loading 4 metadata entries from ss_data_1/metadata.db...
[2025-11-20 04:21:58] Nested metadata hash table initialized: 1024 outer buckets × 64 inner buckets (1024 locks)
[2025-11-20 04:21:58] DEBUG: Lazily created inner table for outer bucket 520
[2025-11-20 04:21:58] Inserted metadata for: c (owner: pat, size: 8, is_backup: 1)
[2025-11-20 04:21:58] DEBUG: Lazily created inner table for outer bucket 523
[2025-11-20 04:21:58] Inserted metadata for: f (owner: pat, size: 0, is_backup: 0)
[2025-11-20 04:21:58] DEBUG: Lazily created inner table for outer bucket 540
[2025-11-20 04:21:58] Inserted metadata for: w (owner: pat, size: 0, is_backup: 1)
[2025-11-20 04:21:58] DEBUG: Lazily created inner table for outer bucket 977
[2025-11-20 04:21:58] Inserted metadata for: ff (owner: bob, size: 9, is_backup: 1)
[2025-11-20 04:21:58] Loaded 4/4 metadata entries from ss_data_1/metadata.db
[2025-11-20 04:21:58] MAIN: Loaded metadata for 4 files from disk
[2025-11-20 04:21:58] MAIN: Listening for Clients and NS on 127.0.0.10:9005
[2025-11-20 04:21:58] MAIN: Listening for Replication on 127.0.0.10:9010
[2025-11-20 04:21:58] MAIN: Core listener & worker threads started (pre-file-scan). Ready for NS control messages.
[2025-11-20 04:21:58] MAIN: File scan complete (0 existing files added post-startup)
[2025-11-20 04:21:58] MAIN: Will send replications to: 127.0.0.2:9002
[2025-11-20 04:21:58] MAIN: Server initialization complete (threads already running). Press Ctrl+C for graceful shutdown.
[2025-11-20 04:21:58] CHECKPOINT: Thread started (interval: 60 seconds)
[2025-11-20 04:21:58] NS_CONTROL: Listener thread started for NS control messages
[2025-11-20 04:21:58] NS_CONTROL: Received message type 60 from NS
[2025-11-20 04:21:58] RECOVERY: NS requests re-replication of all files to backup SS 0 (127.0.0.2:9002)
[2025-11-20 04:21:58] RECOVERY: Initiating immediate re-replication for existing primary files
[2025-11-20 04:21:58] REPL_IN: New incoming replication connection
[2025-11-20 04:21:58] REPL_IN: Receiving replica for ff (9 bytes)
[2025-11-20 04:21:58] REPL: Scheduling update for f
[2025-11-20 04:21:58] REPL: Scheduling update for f
[2025-11-20 04:21:58] REPL_IN: Acquired write lock for ff
[2025-11-20 04:21:58] RECOVERY: Re-replication scheduling complete (1 primary files queued)
[2025-11-20 04:21:58] REPL: Connected to backup. Replicating update for f...
[2025-11-20 04:21:58] REPL: Replicating f (owner: pat, size: 0)
[2025-11-20 04:21:58] REPL_IN: Finished receiving ff
[2025-11-20 04:21:58] Updated metadata for: ff
[2025-11-20 04:21:58] REPL_IN: Updated metadata for ff (owner: bob, size: 9, is_backup=true)
[2025-11-20 04:21:58] REPL_IN: Released write lock for ff
[2025-11-20 04:21:58] REPL: Successfully replicated f (0 bytes)
[2025-11-20 04:21:58] REPL_IN: New incoming replication connection
[2025-11-20 04:21:58] REPL_IN: Receiving replica for w (0 bytes)
[2025-11-20 04:21:58] REPL_IN: Acquired write lock for w
[2025-11-20 04:21:58] REPL_IN: Finished receiving w
[2025-11-20 04:21:58] Updated metadata for: w
[2025-11-20 04:21:58] REPL_IN: Updated metadata for w (owner: pat, size: 0, is_backup=true)
[2025-11-20 04:21:58] REPL_IN: Released write lock for w
[2025-11-20 04:21:58] REPL: ACK received for file f
[2025-11-20 04:21:58] REPL_IN: New incoming replication connection
[2025-11-20 04:21:58] REPL_IN: Receiving replica for c (8 bytes)
[2025-11-20 04:21:58] REPL_IN: Acquired write lock for c
[2025-11-20 04:21:58] REPL_IN: Finished receiving c
[2025-11-20 04:21:58] Updated metadata for: c
[2025-11-20 04:21:58] REPL_IN: Updated metadata for c (owner: pat, size: 8, is_backup=true)
[2025-11-20 04:21:58] REPL_IN: Released write lock for c
[2025-11-20 04:21:58] REPL_IN: New incoming replication connection
[2025-11-20 04:21:58] REPL_IN: Receiving replica for ff (9 bytes)
[2025-11-20 04:21:58] REPL_IN: Acquired write lock for ff
[2025-11-20 04:21:58] REPL_IN: Finished receiving ff
[2025-11-20 04:21:58] Updated metadata for: ff
[2025-11-20 04:21:58] REPL_IN: Updated metadata for ff (owner: bob, size: 9, is_backup=true)
[2025-11-20 04:21:58] REPL_IN: Released write lock for ff
[2025-11-20 04:21:58] REPL_IN: New incoming replication connection
[2025-11-20 04:21:58] REPL_IN: Receiving replica for w (0 bytes)
[2025-11-20 04:21:58] REPL_IN: Acquired write lock for w
[2025-11-20 04:21:58] REPL_IN: Finished receiving w
[2025-11-20 04:21:58] Updated metadata for: w
[2025-11-20 04:21:58] REPL_IN: Updated metadata for w (owner: pat, size: 0, is_backup=true)
[2025-11-20 04:21:58] REPL_IN: Released write lock for w
[2025-11-20 04:21:58] REPL_IN: New incoming replication connection
[2025-11-20 04:21:58] REPL_IN: Receiving replica for c (8 bytes)
[2025-11-20 04:21:58] REPL_IN: Acquired write lock for c
[2025-11-20 04:21:58] REPL_IN: Finished receiving c
[2025-11-20 04:21:58] Updated metadata for: c
[2025-11-20 04:21:58] REPL_IN: Updated metadata for c (owner: pat, size: 8, is_backup=true)
[2025-11-20 04:21:58] REPL_IN: Released write lock for c
[2025-11-20 04:22:17] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 32)
[2025-11-20 04:22:17] DEBUG: Lazily created inner table for outer bucket 470
[2025-11-20 04:22:17] Inserted metadata for: 1 (owner: bob1, size: 0, is_backup: 0)
[2025-11-20 04:22:17] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:22:17] Successfully saved 5 metadata entries (atomic snapshot)
[2025-11-20 04:22:17] CREATE: File 1 created by bob1
[2025-11-20 04:22:17] REPL: Scheduling update for 1
[2025-11-20 04:22:17] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:22:17] REPL: Connected to backup. Replicating update for 1...
[2025-11-20 04:22:17] REPL: Replicating 1 (owner: bob1, size: 0)
[2025-11-20 04:22:17] REPL: Successfully replicated 1 (0 bytes)
[2025-11-20 04:22:17] REPL: ACK received for file 1
[2025-11-20 04:22:19] REPL_IN: New incoming replication connection
[2025-11-20 04:22:19] REPL_IN: Receiving replica for 2 (0 bytes)
[2025-11-20 04:22:19] REPL_IN: Acquired write lock for 2
[2025-11-20 04:22:19] REPL_IN: Finished receiving 2
[2025-11-20 04:22:19] DEBUG: Lazily created inner table for outer bucket 471
[2025-11-20 04:22:19] Inserted metadata for: 2 (owner: bob1, size: 0, is_backup: 1)
[2025-11-20 04:22:19] REPL_IN: Created metadata for 2 (owner: bob1, is_backup=true)
[2025-11-20 04:22:19] REPL_IN: Released write lock for 2
[2025-11-20 04:22:21] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 32)
[2025-11-20 04:22:21] DEBUG: Lazily created inner table for outer bucket 472
[2025-11-20 04:22:21] Inserted metadata for: 3 (owner: bob1, size: 0, is_backup: 0)
[2025-11-20 04:22:21] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:22:21] Successfully saved 7 metadata entries (atomic snapshot)
[2025-11-20 04:22:21] CREATE: File 3 created by bob1
[2025-11-20 04:22:21] REPL: Scheduling update for 3
[2025-11-20 04:22:21] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:22:21] REPL: Connected to backup. Replicating update for 3...
[2025-11-20 04:22:21] REPL: Replicating 3 (owner: bob1, size: 0)
[2025-11-20 04:22:21] REPL: Successfully replicated 3 (0 bytes)
[2025-11-20 04:22:21] REPL: ACK received for file 3
[2025-11-20 04:22:23] REPL_IN: New incoming replication connection
[2025-11-20 04:22:23] REPL_IN: Receiving replica for 4 (0 bytes)
[2025-11-20 04:22:23] REPL_IN: Acquired write lock for 4
[2025-11-20 04:22:23] REPL_IN: Finished receiving 4
[2025-11-20 04:22:23] DEBUG: Lazily created inner table for outer bucket 473
[2025-11-20 04:22:23] Inserted metadata for: 4 (owner: bob1, size: 0, is_backup: 1)
[2025-11-20 04:22:23] REPL_IN: Created metadata for 4 (owner: bob1, is_backup=true)
[2025-11-20 04:22:23] REPL_IN: Released write lock for 4
[2025-11-20 04:22:26] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 42)
[2025-11-20 04:22:26] WRITE: Created swapfile 1 (sentence 0)
[2025-11-20 04:22:26] WRITE: Appending sentence 0 to empty file
[2025-11-20 04:22:32] WRITE: Acquired global file lock for commit (file 1, sentence 0)
[2025-11-20 04:22:32] WRITE: Committed and deleted swapfile for 1 (sentence 0)
[2025-11-20 04:22:32] Updated size for 1: 5 bytes
[2025-11-20 04:22:32] Updated counts for 1: 2 words, 5 chars
[2025-11-20 04:22:32] WRITE: Updated metadata for 1 (size: 5, words: 2, chars: 5)
[2025-11-20 04:22:32] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:22:32] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:22:32] WRITE: Completed for 1 (sentence 0)
[2025-11-20 04:22:32] REPL: Scheduling update for 1
[2025-11-20 04:22:32] REPL: Connected to backup. Replicating update for 1...
[2025-11-20 04:22:32] REPL: Replicating 1 (owner: bob1, size: 5)
[2025-11-20 04:22:32] REPL: Successfully replicated 1 (5 bytes)
[2025-11-20 04:22:32] REPL: ACK received for file 1
[2025-11-20 04:22:43] REPL_IN: New incoming replication connection
[2025-11-20 04:22:43] REPL_IN: Receiving replica for 2 (5 bytes)
[2025-11-20 04:22:43] REPL_IN: Acquired write lock for 2
[2025-11-20 04:22:43] REPL_IN: Finished receiving 2
[2025-11-20 04:22:43] Updated metadata for: 2
[2025-11-20 04:22:43] REPL_IN: Updated metadata for 2 (owner: bob1, size: 5, is_backup=true)
[2025-11-20 04:22:43] REPL_IN: Released write lock for 2
[2025-11-20 04:22:47] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 42)
[2025-11-20 04:22:47] WRITE: Created swapfile 3 (sentence 0)
[2025-11-20 04:22:47] WRITE: Appending sentence 0 to empty file
[2025-11-20 04:22:51] WRITE: Acquired global file lock for commit (file 3, sentence 0)
[2025-11-20 04:22:51] WRITE: Committed and deleted swapfile for 3 (sentence 0)
[2025-11-20 04:22:51] Updated size for 3: 5 bytes
[2025-11-20 04:22:51] Updated counts for 3: 2 words, 5 chars
[2025-11-20 04:22:51] WRITE: Updated metadata for 3 (size: 5, words: 2, chars: 5)
[2025-11-20 04:22:51] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:22:51] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:22:51] WRITE: Completed for 3 (sentence 0)
[2025-11-20 04:22:51] REPL: Scheduling update for 3
[2025-11-20 04:22:51] REPL: Connected to backup. Replicating update for 3...
[2025-11-20 04:22:51] REPL: Replicating 3 (owner: bob1, size: 5)
[2025-11-20 04:22:51] REPL: Successfully replicated 3 (5 bytes)
[2025-11-20 04:22:51] REPL: ACK received for file 3
[2025-11-20 04:22:58] CHECKPOINT: Saving metadata to disk...
[2025-11-20 04:22:58] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:22:58] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:22:58] CHECKPOINT: Metadata saved successfully (8 entries)
[2025-11-20 04:22:59] REPL_IN: New incoming replication connection
[2025-11-20 04:22:59] REPL_IN: Receiving replica for 4 (5 bytes)
[2025-11-20 04:22:59] REPL_IN: Acquired write lock for 4
[2025-11-20 04:22:59] REPL_IN: Finished receiving 4
[2025-11-20 04:22:59] Updated metadata for: 4
[2025-11-20 04:22:59] REPL_IN: Updated metadata for 4 (owner: bob1, size: 5, is_backup=true)
[2025-11-20 04:22:59] REPL_IN: Released write lock for 4
[2025-11-20 04:23:00] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 34)
[2025-11-20 04:23:00] INFO: NS requesting metadata for 1 (for VIEW -l)
[2025-11-20 04:23:00] INFO: Returning cached metadata for 1 (size: 5, words: 2, chars: 5)
[2025-11-20 04:23:00] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:00] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 34)
[2025-11-20 04:23:00] INFO: NS requesting metadata for 3 (for VIEW -l)
[2025-11-20 04:23:00] INFO: Returning cached metadata for 3 (size: 5, words: 2, chars: 5)
[2025-11-20 04:23:00] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:20] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 40)
[2025-11-20 04:23:20] HANDLER: Routing to ss_handle_read() for message type 40
[2025-11-20 04:23:20] READ: Handler called for file '1'
[2025-11-20 04:23:20] READ: Starting read for file 1
[2025-11-20 04:23:20] READ: Full path is ss_data_1/files/1
[2025-11-20 04:23:20] READ: File opened successfully, starting to read chunks
[2025-11-20 04:23:20] READ: Chunk 1 - read 5 bytes, is_final=1
[2025-11-20 04:23:20] READ: Chunk 1 sent
[2025-11-20 04:23:20] READ: Read complete for 1, sent 1 chunks
[2025-11-20 04:23:20] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:22] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 40)
[2025-11-20 04:23:22] HANDLER: Routing to ss_handle_read() for message type 40
[2025-11-20 04:23:22] READ: Handler called for file '2'
[2025-11-20 04:23:22] READ: Starting read for file 2
[2025-11-20 04:23:22] READ: Full path is ss_data_1/files/2
[2025-11-20 04:23:22] READ: File opened successfully, starting to read chunks
[2025-11-20 04:23:22] READ: Chunk 1 - read 5 bytes, is_final=1
[2025-11-20 04:23:22] READ: Chunk 1 sent
[2025-11-20 04:23:22] READ: Read complete for 2, sent 1 chunks
[2025-11-20 04:23:22] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:23] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 40)
[2025-11-20 04:23:23] HANDLER: Routing to ss_handle_read() for message type 40
[2025-11-20 04:23:23] READ: Handler called for file '3'
[2025-11-20 04:23:23] READ: Starting read for file 3
[2025-11-20 04:23:23] READ: Full path is ss_data_1/files/3
[2025-11-20 04:23:23] READ: File opened successfully, starting to read chunks
[2025-11-20 04:23:23] READ: Chunk 1 - read 5 bytes, is_final=1
[2025-11-20 04:23:23] READ: Chunk 1 sent
[2025-11-20 04:23:23] READ: Read complete for 3, sent 1 chunks
[2025-11-20 04:23:23] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:25] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 40)
[2025-11-20 04:23:25] HANDLER: Routing to ss_handle_read() for message type 40
[2025-11-20 04:23:25] READ: Handler called for file '4'
[2025-11-20 04:23:25] READ: Starting read for file 4
[2025-11-20 04:23:25] READ: Full path is ss_data_1/files/4
[2025-11-20 04:23:25] READ: File opened successfully, starting to read chunks
[2025-11-20 04:23:25] READ: Chunk 1 - read 5 bytes, is_final=1
[2025-11-20 04:23:25] READ: Chunk 1 sent
[2025-11-20 04:23:25] READ: Read complete for 4, sent 1 chunks
[2025-11-20 04:23:25] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:33] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 34)
[2025-11-20 04:23:33] INFO: NS requesting metadata for 2 (for VIEW -l)
[2025-11-20 04:23:33] INFO: Returning cached metadata for 2 (size: 5, words: 0, chars: 0)
[2025-11-20 04:23:33] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:33] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 34)
[2025-11-20 04:23:33] INFO: NS requesting metadata for 4 (for VIEW -l)
[2025-11-20 04:23:33] INFO: Returning cached metadata for 4 (size: 5, words: 0, chars: 0)
[2025-11-20 04:23:33] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:33] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 34)
[2025-11-20 04:23:33] INFO: NS requesting metadata for 1 (for VIEW -l)
[2025-11-20 04:23:33] INFO: Returning cached metadata for 1 (size: 5, words: 2, chars: 5)
[2025-11-20 04:23:33] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:33] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 34)
[2025-11-20 04:23:33] INFO: NS requesting metadata for 3 (for VIEW -l)
[2025-11-20 04:23:33] INFO: Returning cached metadata for 3 (size: 5, words: 2, chars: 5)
[2025-11-20 04:23:33] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:37] NS_CONTROL: Received message type 61 from NS
[2025-11-20 04:23:37] HANDLER: Received backup assignment update from NS
[2025-11-20 04:23:37] HANDLER: Backup assignment updated - will replicate to 127.0.0.2:9002 (SS ID 0)
[2025-11-20 04:23:37] HANDLER: Initiating immediate catch-up replication for existing primary files
[2025-11-20 04:23:37] REPL: Scheduling update for f
[2025-11-20 04:23:37] REPL: Scheduling update for 1
[2025-11-20 04:23:37] REPL: Scheduling update for 3
[2025-11-20 04:23:37] HANDLER: Catch-up replication scheduling complete (3 primary files queued)
[2025-11-20 04:23:37] NS_CONTROL: Received message type 58 from NS
[2025-11-20 04:23:37] RECOVERY: NS requests sync FROM backup TO primary SS 0 (127.0.0.2:9002)
[2025-11-20 04:23:37] REPL: Could not connect to backup server at 127.0.0.2:9002
[2025-11-20 04:23:37] REPL: Re-queueing f for retry attempt 1
[2025-11-20 04:23:37] RECOVERY: Failed to connect to primary SS 0 at 127.0.0.2:9002
[2025-11-20 04:23:37] REPL: Could not connect to backup server at 127.0.0.2:9002
[2025-11-20 04:23:37] REPL: Re-queueing 1 for retry attempt 1
[2025-11-20 04:23:37] REPL: Could not connect to backup server at 127.0.0.2:9002
[2025-11-20 04:23:37] REPL: Re-queueing 3 for retry attempt 1
[2025-11-20 04:23:37] REPL: Could not connect to backup server at 127.0.0.2:9002
[2025-11-20 04:23:37] REPL: Re-queueing f for retry attempt 2
[2025-11-20 04:23:37] REPL: Connected to backup. Replicating update for 1...
[2025-11-20 04:23:37] REPL: Replicating 1 (owner: bob1, size: 5)
[2025-11-20 04:23:37] REPL: Successfully replicated 1 (5 bytes)
[2025-11-20 04:23:37] REPL: ACK received for file 1
[2025-11-20 04:23:37] REPL_IN: New incoming replication connection
[2025-11-20 04:23:37] REPL_IN: Receiving replica for 2 (5 bytes)
[2025-11-20 04:23:37] REPL_IN: Acquired write lock for 2
[2025-11-20 04:23:37] REPL: Connected to backup. Replicating update for 3...
[2025-11-20 04:23:37] REPL: Replicating 3 (owner: bob1, size: 5)
[2025-11-20 04:23:37] REPL_IN: Finished receiving 2
[2025-11-20 04:23:37] Updated metadata for: 2
[2025-11-20 04:23:37] REPL_IN: Updated metadata for 2 (owner: bob1, size: 5, is_backup=true)
[2025-11-20 04:23:37] REPL_IN: Released write lock for 2
[2025-11-20 04:23:37] REPL: Successfully replicated 3 (5 bytes)
[2025-11-20 04:23:37] REPL_IN: New incoming replication connection
[2025-11-20 04:23:37] REPL: ACK received for file 3
[2025-11-20 04:23:37] REPL_IN: Receiving replica for 4 (5 bytes)
[2025-11-20 04:23:37] REPL_IN: Acquired write lock for 4
[2025-11-20 04:23:37] REPL: Connected to backup. Replicating update for f...
[2025-11-20 04:23:37] REPL_IN: Finished receiving 4
[2025-11-20 04:23:37] Updated metadata for: 4
[2025-11-20 04:23:37] REPL_IN: Updated metadata for 4 (owner: bob1, size: 5, is_backup=true)
[2025-11-20 04:23:37] REPL_IN: Released write lock for 4
[2025-11-20 04:23:37] REPL: Replicating f (owner: pat, size: 0)
[2025-11-20 04:23:37] REPL: Successfully replicated f (0 bytes)
[2025-11-20 04:23:37] REPL_IN: New incoming replication connection
[2025-11-20 04:23:37] REPL_IN: Receiving replica for w (0 bytes)
[2025-11-20 04:23:37] REPL_IN: Acquired write lock for w
[2025-11-20 04:23:37] REPL: ACK received for file f
[2025-11-20 04:23:37] REPL_IN: Finished receiving w
[2025-11-20 04:23:37] Updated metadata for: w
[2025-11-20 04:23:37] REPL_IN: Updated metadata for w (owner: pat, size: 0, is_backup=true)
[2025-11-20 04:23:37] REPL_IN: Released write lock for w
[2025-11-20 04:23:37] REPL_IN: New incoming replication connection
[2025-11-20 04:23:37] REPL_IN: Receiving replica for c (8 bytes)
[2025-11-20 04:23:37] REPL_IN: Acquired write lock for c
[2025-11-20 04:23:37] REPL_IN: Finished receiving c
[2025-11-20 04:23:37] Updated metadata for: c
[2025-11-20 04:23:37] REPL_IN: Updated metadata for c (owner: pat, size: 8, is_backup=true)
[2025-11-20 04:23:37] REPL_IN: Released write lock for c
[2025-11-20 04:23:37] REPL_IN: New incoming replication connection
[2025-11-20 04:23:37] REPL_IN: Receiving replica for ff (9 bytes)
[2025-11-20 04:23:37] REPL_IN: Acquired write lock for ff
[2025-11-20 04:23:37] REPL_IN: Finished receiving ff
[2025-11-20 04:23:37] Updated metadata for: ff
[2025-11-20 04:23:37] REPL_IN: Updated metadata for ff (owner: bob, size: 9, is_backup=true)
[2025-11-20 04:23:37] REPL_IN: Released write lock for ff
[2025-11-20 04:23:43] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 40)
[2025-11-20 04:23:43] HANDLER: Routing to ss_handle_read() for message type 40
[2025-11-20 04:23:43] READ: Handler called for file '1'
[2025-11-20 04:23:43] READ: Starting read for file 1
[2025-11-20 04:23:43] READ: Full path is ss_data_1/files/1
[2025-11-20 04:23:43] READ: File opened successfully, starting to read chunks
[2025-11-20 04:23:43] READ: Chunk 1 - read 5 bytes, is_final=1
[2025-11-20 04:23:43] READ: Chunk 1 sent
[2025-11-20 04:23:43] READ: Read complete for 1, sent 1 chunks
[2025-11-20 04:23:43] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:45] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 40)
[2025-11-20 04:23:45] HANDLER: Routing to ss_handle_read() for message type 40
[2025-11-20 04:23:45] READ: Handler called for file '3'
[2025-11-20 04:23:45] READ: Starting read for file 3
[2025-11-20 04:23:45] READ: Full path is ss_data_1/files/3
[2025-11-20 04:23:45] READ: File opened successfully, starting to read chunks
[2025-11-20 04:23:45] READ: Chunk 1 - read 5 bytes, is_final=1
[2025-11-20 04:23:45] READ: Chunk 1 sent
[2025-11-20 04:23:45] READ: Read complete for 3, sent 1 chunks
[2025-11-20 04:23:45] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:55] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 34)
[2025-11-20 04:23:55] INFO: NS requesting metadata for 1 (for VIEW -l)
[2025-11-20 04:23:55] INFO: Returning cached metadata for 1 (size: 5, words: 2, chars: 5)
[2025-11-20 04:23:55] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:55] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 34)
[2025-11-20 04:23:55] INFO: NS requesting metadata for 3 (for VIEW -l)
[2025-11-20 04:23:55] INFO: Returning cached metadata for 3 (size: 5, words: 2, chars: 5)
[2025-11-20 04:23:55] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:23:58] CHECKPOINT: Saving metadata to disk...
[2025-11-20 04:23:58] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:23:58] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:23:58] CHECKPOINT: Metadata saved successfully (8 entries)
[2025-11-20 04:24:58] CHECKPOINT: Saving metadata to disk...
[2025-11-20 04:24:58] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:24:58] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:24:58] CHECKPOINT: Metadata saved successfully (8 entries)
[2025-11-20 04:25:20] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 42)
[2025-11-20 04:25:20] WRITE: Created swapfile 1 (sentence 0)
[2025-11-20 04:25:25] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 42)
[2025-11-20 04:25:25] WRITE: Created swapfile 1 (sentence 1)
[2025-11-20 04:25:25] WRITE: Cannot append sentence 1 - last sentence does not end with delimiter
[2025-11-20 04:25:36] WRITE: Acquired global file lock for commit (file 1, sentence 0)
[2025-11-20 04:25:36] WRITE: Committed and deleted swapfile for 1 (sentence 0)
[2025-11-20 04:25:36] Updated size for 1: 7 bytes
[2025-11-20 04:25:36] Updated counts for 1: 3 words, 7 chars
[2025-11-20 04:25:36] WRITE: Updated metadata for 1 (size: 7, words: 3, chars: 7)
[2025-11-20 04:25:36] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:25:36] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:25:36] WRITE: Completed for 1 (sentence 0)
[2025-11-20 04:25:36] REPL: Scheduling update for 1
[2025-11-20 04:25:36] REPL: Connected to backup. Replicating update for 1...
[2025-11-20 04:25:36] REPL: Replicating 1 (owner: bob1, size: 7)
[2025-11-20 04:25:36] REPL: Successfully replicated 1 (7 bytes)
[2025-11-20 04:25:36] REPL: ACK received for file 1
[2025-11-20 04:25:41] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 34)
[2025-11-20 04:25:41] INFO: NS requesting metadata for 1 (for VIEW -l)
[2025-11-20 04:25:41] INFO: Returning cached metadata for 1 (size: 7, words: 3, chars: 7)
[2025-11-20 04:25:41] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:25:41] HANDLER: New NAME SERVER connection from 127.0.0.1 (Req: 34)
[2025-11-20 04:25:41] INFO: NS requesting metadata for 3 (for VIEW -l)
[2025-11-20 04:25:41] INFO: Returning cached metadata for 3 (size: 5, words: 2, chars: 5)
[2025-11-20 04:25:41] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:25:53] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 42)
[2025-11-20 04:25:53] WRITE: Created swapfile 1 (sentence 1)
[2025-11-20 04:25:58] CHECKPOINT: Saving metadata to disk...
[2025-11-20 04:25:58] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:25:58] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:25:58] CHECKPOINT: Metadata saved successfully (8 entries)
[2025-11-20 04:26:00] MAIN: Shutdown detected. Joining threads and performing final cleanup...
[2025-11-20 04:26:00] CHECKPOINT: Thread exiting
[2025-11-20 04:26:00] REPL_LISTENER: Thread exiting
[2025-11-20 04:26:00] NS_CONTROL: Listener thread exiting
[2025-11-20 04:26:01] CLIENT_LISTENER: Thread exiting
[2025-11-20 04:26:03] HEARTBEAT: Thread exiting
[2025-11-20 04:26:03] MAIN: Performing final metadata save (8 entries)...
[2025-11-20 04:26:03] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:26:03] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:26:03] MAIN: Final metadata save successful
[2025-11-20 04:26:03] Nested metadata hash table freed (1024 locks destroyed)
[2025-11-20 04:26:03] REPL: Worker thread shutting down.
[2025-11-20 04:26:03] --- LOGGING STOPPED ---
[2025-11-20 04:27:17] --- LOGGING STARTED ---
[2025-11-20 04:27:17] MAIN: Persistent log file initialized for SS ID 1
[2025-11-20 04:27:17] MAIN: Using persistent data directory: ss_data_1
[2025-11-20 04:27:17] MAIN: Loading metadata hash table (post-registration)...
[2025-11-20 04:27:17] Loading 8 metadata entries from ss_data_1/metadata.db...
[2025-11-20 04:27:17] Nested metadata hash table initialized: 1024 outer buckets × 64 inner buckets (1024 locks)
[2025-11-20 04:27:17] DEBUG: Lazily created inner table for outer bucket 470
[2025-11-20 04:27:17] Inserted metadata for: 1 (owner: bob1, size: 7, is_backup: 0)
[2025-11-20 04:27:17] DEBUG: Lazily created inner table for outer bucket 471
[2025-11-20 04:27:17] Inserted metadata for: 2 (owner: bob1, size: 5, is_backup: 1)
[2025-11-20 04:27:17] DEBUG: Lazily created inner table for outer bucket 472
[2025-11-20 04:27:17] Inserted metadata for: 3 (owner: bob1, size: 5, is_backup: 0)
[2025-11-20 04:27:17] DEBUG: Lazily created inner table for outer bucket 473
[2025-11-20 04:27:17] Inserted metadata for: 4 (owner: bob1, size: 5, is_backup: 1)
[2025-11-20 04:27:17] DEBUG: Lazily created inner table for outer bucket 520
[2025-11-20 04:27:17] Inserted metadata for: c (owner: pat, size: 8, is_backup: 1)
[2025-11-20 04:27:17] DEBUG: Lazily created inner table for outer bucket 523
[2025-11-20 04:27:17] Inserted metadata for: f (owner: pat, size: 0, is_backup: 0)
[2025-11-20 04:27:17] DEBUG: Lazily created inner table for outer bucket 540
[2025-11-20 04:27:17] Inserted metadata for: w (owner: pat, size: 0, is_backup: 1)
[2025-11-20 04:27:17] DEBUG: Lazily created inner table for outer bucket 977
[2025-11-20 04:27:17] Inserted metadata for: ff (owner: bob, size: 9, is_backup: 1)
[2025-11-20 04:27:17] Loaded 8/8 metadata entries from ss_data_1/metadata.db
[2025-11-20 04:27:17] MAIN: Loaded metadata for 8 files from disk
[2025-11-20 04:27:17] MAIN: Listening for Clients and NS on 127.0.0.10:9005
[2025-11-20 04:27:17] MAIN: Core listener & worker threads started (pre-file-scan). Ready for NS control messages.
[2025-11-20 04:27:17] NS_CONTROL: Listener thread started for NS control messages
[2025-11-20 04:27:17] MAIN: File scan complete (0 existing files added post-startup)
[2025-11-20 04:27:17] MAIN: Will send replications to: 127.0.0.2:9002
[2025-11-20 04:27:17] MAIN: This is a recovery. Waiting for NS to coordinate recovery sync...
[2025-11-20 04:27:17] MAIN: Server initialization complete (threads already running). Press Ctrl+C for graceful shutdown.
[2025-11-20 04:27:17] NS_CONTROL: Received message type 61 from NS
[2025-11-20 04:27:17] HANDLER: Received backup assignment update from NS
[2025-11-20 04:27:17] HANDLER: Backup assignment updated - will replicate to 127.0.0.2:9002 (SS ID 0)
[2025-11-20 04:27:17] HANDLER: Initiating immediate catch-up replication for existing primary files
[2025-11-20 04:27:17] MAIN: Listening for Replication on 127.0.0.10:9010
[2025-11-20 04:27:17] CHECKPOINT: Thread started (interval: 60 seconds)
[2025-11-20 04:27:17] REPL: Scheduling update for f
[2025-11-20 04:27:17] REPL: Scheduling update for 1
[2025-11-20 04:27:17] REPL: Scheduling update for 3
[2025-11-20 04:27:17] REPL_IN: New incoming replication connection
[2025-11-20 04:27:17] HANDLER: Catch-up replication scheduling complete (3 primary files queued)
[2025-11-20 04:27:17] NS_CONTROL: Received message type 59 from NS
[2025-11-20 04:27:17] RECOVERY: NS requests sync TO primary (us) FROM backup SS 0 (127.0.0.2:9002)
[2025-11-20 04:27:17] RECOVERY: Waiting for backup SS 0 to initiate recovery connection
[2025-11-20 04:27:17] REPL_IN: Receiving replica for w (0 bytes)
[2025-11-20 04:27:17] REPL_IN: Acquired write lock for w
[2025-11-20 04:27:17] REPL: Connected to backup. Replicating update for f...
[2025-11-20 04:27:17] REPL: Replicating f (owner: pat, size: 0)
[2025-11-20 04:27:17] REPL_IN: Finished receiving w
[2025-11-20 04:27:17] Updated metadata for: w
[2025-11-20 04:27:17] REPL_IN: Updated metadata for w (owner: pat, size: 0, is_backup=true)
[2025-11-20 04:27:17] REPL_IN: Released write lock for w
[2025-11-20 04:27:17] REPL: Successfully replicated f (0 bytes)
[2025-11-20 04:27:17] REPL_IN: New incoming replication connection
[2025-11-20 04:27:17] REPL_IN: Receiving replica for c (8 bytes)
[2025-11-20 04:27:17] REPL_IN: Acquired write lock for c
[2025-11-20 04:27:17] REPL: ACK received for file f
[2025-11-20 04:27:17] REPL_IN: Finished receiving c
[2025-11-20 04:27:17] Updated metadata for: c
[2025-11-20 04:27:17] REPL_IN: Updated metadata for c (owner: pat, size: 8, is_backup=true)
[2025-11-20 04:27:17] REPL_IN: Released write lock for c
[2025-11-20 04:27:17] REPL: Connected to backup. Replicating update for 1...
[2025-11-20 04:27:17] REPL: Replicating 1 (owner: bob1, size: 7)
[2025-11-20 04:27:17] REPL: Successfully replicated 1 (7 bytes)
[2025-11-20 04:27:17] REPL_IN: New incoming replication connection
[2025-11-20 04:27:17] REPL_IN: Receiving replica for ff (9 bytes)
[2025-11-20 04:27:17] REPL_IN: Acquired write lock for ff
[2025-11-20 04:27:17] REPL_IN: Finished receiving ff
[2025-11-20 04:27:17] Updated metadata for: ff
[2025-11-20 04:27:17] REPL_IN: Updated metadata for ff (owner: bob, size: 9, is_backup=true)
[2025-11-20 04:27:17] REPL_IN: Released write lock for ff
[2025-11-20 04:27:17] REPL: ACK received for file 1
[2025-11-20 04:27:17] REPL_IN: New incoming replication connection
[2025-11-20 04:27:17] REPL_IN: Receiving replica for 2 (5 bytes)
[2025-11-20 04:27:17] REPL_IN: Acquired write lock for 2
[2025-11-20 04:27:17] REPL: Connected to backup. Replicating update for 3...
[2025-11-20 04:27:17] REPL: Replicating 3 (owner: bob1, size: 5)
[2025-11-20 04:27:17] REPL_IN: Finished receiving 2
[2025-11-20 04:27:17] Updated metadata for: 2
[2025-11-20 04:27:17] REPL_IN: Updated metadata for 2 (owner: bob1, size: 5, is_backup=true)
[2025-11-20 04:27:17] REPL_IN: Released write lock for 2
[2025-11-20 04:27:17] REPL: Successfully replicated 3 (5 bytes)
[2025-11-20 04:27:17] REPL_IN: New incoming replication connection
[2025-11-20 04:27:17] REPL_IN: Receiving replica for 4 (5 bytes)
[2025-11-20 04:27:17] REPL_IN: Acquired write lock for 4
[2025-11-20 04:27:17] REPL_IN: Finished receiving 4
[2025-11-20 04:27:17] Updated metadata for: 4
[2025-11-20 04:27:17] REPL_IN: Updated metadata for 4 (owner: bob1, size: 5, is_backup=true)
[2025-11-20 04:27:17] REPL_IN: Released write lock for 4
[2025-11-20 04:27:17] REPL: ACK received for file 3
[2025-11-20 04:27:29] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 41)
[2025-11-20 04:27:29] HANDLER: Routing to ss_handle_stream() for message type 41
[2025-11-20 04:27:29] STREAM: Handler called for file '1'
[2025-11-20 04:27:30] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:28:17] CHECKPOINT: Saving metadata to disk...
[2025-11-20 04:28:17] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:28:17] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:28:17] CHECKPOINT: Metadata saved successfully (8 entries)
[2025-11-20 04:28:44] HANDLER: New CLIENT connection from 127.0.0.1 (Req: 40)
[2025-11-20 04:28:44] HANDLER: Routing to ss_handle_read() for message type 40
[2025-11-20 04:28:44] READ: Handler called for file '1'
[2025-11-20 04:28:44] READ: Starting read for file 1
[2025-11-20 04:28:44] READ: Full path is ss_data_1/files/1
[2025-11-20 04:28:44] READ: File opened successfully, starting to read chunks
[2025-11-20 04:28:44] READ: Chunk 1 - read 7 bytes, is_final=1
[2025-11-20 04:28:44] READ: Chunk 1 sent
[2025-11-20 04:28:44] READ: Read complete for 1, sent 1 chunks
[2025-11-20 04:28:44] HANDLER: Closing connection from 127.0.0.1
[2025-11-20 04:29:17] CHECKPOINT: Saving metadata to disk...
[2025-11-20 04:29:17] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:29:17] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:29:17] CHECKPOINT: Metadata saved successfully (8 entries)
[2025-11-20 04:30:17] CHECKPOINT: Saving metadata to disk...
[2025-11-20 04:30:17] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:30:17] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:30:17] CHECKPOINT: Metadata saved successfully (8 entries)
[2025-11-20 04:31:17] CHECKPOINT: Saving metadata to disk...
[2025-11-20 04:31:17] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:31:17] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:31:17] CHECKPOINT: Metadata saved successfully (8 entries)
[2025-11-20 04:32:17] CHECKPOINT: Saving metadata to disk...
[2025-11-20 04:32:17] Saving metadata to ss_data_1/metadata.db (atomic snapshot)...
[2025-11-20 04:32:17] Successfully saved 8 metadata entries (atomic snapshot)
[2025-11-20 04:32:17] CHECKPOINT: Metadata saved successfully (8 entries)
